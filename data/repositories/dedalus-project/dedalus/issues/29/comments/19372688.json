{"links": {"self": {"href": "data/repositories/dedalus-project/dedalus/issues/29/comments/19372688.json"}, "html": {"href": "#!/dedalus-project/dedalus/issues/29#comment-19372688"}}, "issue": {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus/issues/29.json"}}, "type": "issue", "id": 29, "repository": {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus.json"}, "html": {"href": "#!/dedalus-project/dedalus"}, "avatar": {"href": "data/bytebucket.org/ravatar/{1dc39ab6-2798-450d-af2f-e976f94b5794}ts=2009435"}}, "type": "repository", "name": "dedalus", "full_name": "dedalus-project/dedalus", "uuid": "{1dc39ab6-2798-450d-af2f-e976f94b5794}"}, "title": "Proper evaluation of duplicated subtrees"}, "content": {"raw": "Keaton,\n     Just tested your fix, and it works.  Interestingly, \"enstrophy\" is not the only repeated analysis substitution, but it is the only substitution that appears 3 times (the rest appear twice).  For example, this KE sub works just fine with no \"store_last=True\" flag:\n\n\n```\n#!python\n\nself.problem.substitutions['KE'] = 'rho_full*(u**2+w**2)/2'\n<...>\nanalysis_profile.add_task(\"plane_avg(KE)\", name=\"KE\")\n<...>\nanalysis_scalar.add_task(\"vol_avg(KE)\", name=\"KE\")\n```\n whereas the enstrophy sub requires that fix:\n\n```\n#!python\n\nself.problem.substitutions['enstrophy'] = '(dx(w) - u_z)**2'\n<...>\nanalysis_slice.add_task(\"enstrophy\", name=\"enstrophy\")\n<...>\nanalysis_profile.add_task(\"plane_avg(enstrophy)\", name=\"enstrophy\")\n<...>\nanalysis_scalar.add_task(\"vol_avg(enstrophy)\", name=\"enstrophy\")\n<...>\nself.problem.namespace['enstrophy'].store_last = True\n\n```\nIf you want to dig into this more, these subs are being set in equations.py in bpbrown/polytrope here:\n\nhttps://bitbucket.org/bpbrown/polytrope/src/3d7a3022f4c4c23db02bb796bf5fa11c38cb276f/equations.py?at=default#cl-352\n\n(private repo, just sent invite to Keaton).\n\n\nYes, please change the title of the issue.\n", "markup": "markdown", "html": "<p>Keaton,\n     Just tested your fix, and it works.  Interestingly, \"enstrophy\" is not the only repeated analysis substitution, but it is the only substitution that appears 3 times (the rest appear twice).  For example, this KE sub works just fine with no \"store_last=True\" flag:</p>\n<div class=\"codehilite language-python\"><pre><span></span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">problem</span><span class=\"o\">.</span><span class=\"n\">substitutions</span><span class=\"p\">[</span><span class=\"s1\">&#39;KE&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;rho_full*(u**2+w**2)/2&#39;</span>\n<span class=\"o\">&lt;...&gt;</span>\n<span class=\"n\">analysis_profile</span><span class=\"o\">.</span><span class=\"n\">add_task</span><span class=\"p\">(</span><span class=\"s2\">&quot;plane_avg(KE)&quot;</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;KE&quot;</span><span class=\"p\">)</span>\n<span class=\"o\">&lt;...&gt;</span>\n<span class=\"n\">analysis_scalar</span><span class=\"o\">.</span><span class=\"n\">add_task</span><span class=\"p\">(</span><span class=\"s2\">&quot;vol_avg(KE)&quot;</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;KE&quot;</span><span class=\"p\">)</span>\n</pre></div>\n\n\n<p>whereas the enstrophy sub requires that fix:</p>\n<div class=\"codehilite language-python\"><pre><span></span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">problem</span><span class=\"o\">.</span><span class=\"n\">substitutions</span><span class=\"p\">[</span><span class=\"s1\">&#39;enstrophy&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;(dx(w) - u_z)**2&#39;</span>\n<span class=\"o\">&lt;...&gt;</span>\n<span class=\"n\">analysis_slice</span><span class=\"o\">.</span><span class=\"n\">add_task</span><span class=\"p\">(</span><span class=\"s2\">&quot;enstrophy&quot;</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;enstrophy&quot;</span><span class=\"p\">)</span>\n<span class=\"o\">&lt;...&gt;</span>\n<span class=\"n\">analysis_profile</span><span class=\"o\">.</span><span class=\"n\">add_task</span><span class=\"p\">(</span><span class=\"s2\">&quot;plane_avg(enstrophy)&quot;</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;enstrophy&quot;</span><span class=\"p\">)</span>\n<span class=\"o\">&lt;...&gt;</span>\n<span class=\"n\">analysis_scalar</span><span class=\"o\">.</span><span class=\"n\">add_task</span><span class=\"p\">(</span><span class=\"s2\">&quot;vol_avg(enstrophy)&quot;</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;enstrophy&quot;</span><span class=\"p\">)</span>\n<span class=\"o\">&lt;...&gt;</span>\n<span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">problem</span><span class=\"o\">.</span><span class=\"n\">namespace</span><span class=\"p\">[</span><span class=\"s1\">&#39;enstrophy&#39;</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">store_last</span> <span class=\"o\">=</span> <span class=\"bp\">True</span>\n</pre></div>\n\n\n<p>If you want to dig into this more, these subs are being set in equations.py in <a href=\"https://bitbucket.org/bpbrown/polytrope\" rel=\"nofollow\" class=\"ap-connect-link\">bpbrown/polytrope</a> here:</p>\n<p><a href=\"https://bitbucket.org/bpbrown/polytrope/src/3d7a3022f4c4c23db02bb796bf5fa11c38cb276f/equations.py?at=default#cl-352\" rel=\"nofollow\" class=\"ap-connect-link\">https://bitbucket.org/bpbrown/polytrope/src/3d7a3022f4c4c23db02bb796bf5fa11c38cb276f/equations.py?at=default#cl-352</a></p>\n<p>(private repo, just sent invite to Keaton).</p>\n<p>Yes, please change the title of the issue.</p>", "type": "rendered"}, "created_on": "2015-06-29T18:24:08.465307+00:00", "user": {"display_name": "Benjamin Brown", "uuid": "{7ccecdb3-3639-4001-8249-060e80320bda}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B7ccecdb3-3639-4001-8249-060e80320bda%7D"}, "html": {"href": "https://bitbucket.org/%7B7ccecdb3-3639-4001-8249-060e80320bda%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:0696c4b9-e94c-41ac-82be-62ad4f0ec571/8bc6f4da-871a-48b1-88ea-998663d18142/128"}}, "nickname": "Benjamin Brown", "type": "user", "account_id": "557058:0696c4b9-e94c-41ac-82be-62ad4f0ec571"}, "updated_on": null, "type": "issue_comment", "id": 19372688}