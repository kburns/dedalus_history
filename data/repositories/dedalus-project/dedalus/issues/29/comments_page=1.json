{"pagelen": 100, "values": [{"links": {"self": {"href": "data/repositories/dedalus-project/dedalus/issues/29/comments/19363278.json"}, "html": {"href": "#!/dedalus-project/dedalus/issues/29#comment-19363278"}}, "issue": {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus/issues/29.json"}}, "type": "issue", "id": 29, "repository": {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus.json"}, "html": {"href": "#!/dedalus-project/dedalus"}, "avatar": {"href": "data/bytebucket.org/ravatar/{1dc39ab6-2798-450d-af2f-e976f94b5794}ts=2009435"}}, "type": "repository", "name": "dedalus", "full_name": "dedalus-project/dedalus", "uuid": "{1dc39ab6-2798-450d-af2f-e976f94b5794}"}, "title": "Proper evaluation of duplicated subtrees"}, "content": {"raw": "This bug comes up when there are redundant subtrees being evaluated simultaneously.  I'm working on a better long-term solution for this process, but currently you can set an attribute on an operator that will cache its output within each solver iteration, which should fix this problem.  \n\nAfter you've added all parameters/substitutions, you want to set the `store_last` attribute to True on any non-function substitutions that you use in multiple equations / analysis tasks.  Here that would be:\n\nproblem.namespace['enstrophy'].store_last = True\n\nWe could do this as the default for all operators, but that may result in memory issues.  I'll change this to on-hold for now, and maybe change the issue title to reflect the (very obscure) source of the bug, if that's ok with you.", "markup": "markdown", "html": "<p>This bug comes up when there are redundant subtrees being evaluated simultaneously.  I'm working on a better long-term solution for this process, but currently you can set an attribute on an operator that will cache its output within each solver iteration, which should fix this problem.  </p>\n<p>After you've added all parameters/substitutions, you want to set the <code>store_last</code> attribute to True on any non-function substitutions that you use in multiple equations / analysis tasks.  Here that would be:</p>\n<p>problem.namespace['enstrophy'].store_last = True</p>\n<p>We could do this as the default for all operators, but that may result in memory issues.  I'll change this to on-hold for now, and maybe change the issue title to reflect the (very obscure) source of the bug, if that's ok with you.</p>", "type": "rendered"}, "created_on": "2015-06-29T12:19:20.614835+00:00", "user": {"display_name": "Keaton Burns", "uuid": "{3d3e64f1-bf12-45df-b655-4543d8fb34c4}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B3d3e64f1-bf12-45df-b655-4543d8fb34c4%7D"}, "html": {"href": "https://bitbucket.org/%7B3d3e64f1-bf12-45df-b655-4543d8fb34c4%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:e31a7835-5317-4dfa-8551-f32a06f40279/40f33f99-2b75-4a17-a8c2-07c8d74c7480/128"}}, "nickname": "kburns", "type": "user", "account_id": "557058:e31a7835-5317-4dfa-8551-f32a06f40279"}, "updated_on": null, "type": "issue_comment", "id": 19363278}, {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus/issues/29/comments/19372688.json"}, "html": {"href": "#!/dedalus-project/dedalus/issues/29#comment-19372688"}}, "issue": {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus/issues/29.json"}}, "type": "issue", "id": 29, "repository": {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus.json"}, "html": {"href": "#!/dedalus-project/dedalus"}, "avatar": {"href": "data/bytebucket.org/ravatar/{1dc39ab6-2798-450d-af2f-e976f94b5794}ts=2009435"}}, "type": "repository", "name": "dedalus", "full_name": "dedalus-project/dedalus", "uuid": "{1dc39ab6-2798-450d-af2f-e976f94b5794}"}, "title": "Proper evaluation of duplicated subtrees"}, "content": {"raw": "Keaton,\n     Just tested your fix, and it works.  Interestingly, \"enstrophy\" is not the only repeated analysis substitution, but it is the only substitution that appears 3 times (the rest appear twice).  For example, this KE sub works just fine with no \"store_last=True\" flag:\n\n\n```\n#!python\n\nself.problem.substitutions['KE'] = 'rho_full*(u**2+w**2)/2'\n<...>\nanalysis_profile.add_task(\"plane_avg(KE)\", name=\"KE\")\n<...>\nanalysis_scalar.add_task(\"vol_avg(KE)\", name=\"KE\")\n```\n whereas the enstrophy sub requires that fix:\n\n```\n#!python\n\nself.problem.substitutions['enstrophy'] = '(dx(w) - u_z)**2'\n<...>\nanalysis_slice.add_task(\"enstrophy\", name=\"enstrophy\")\n<...>\nanalysis_profile.add_task(\"plane_avg(enstrophy)\", name=\"enstrophy\")\n<...>\nanalysis_scalar.add_task(\"vol_avg(enstrophy)\", name=\"enstrophy\")\n<...>\nself.problem.namespace['enstrophy'].store_last = True\n\n```\nIf you want to dig into this more, these subs are being set in equations.py in bpbrown/polytrope here:\n\nhttps://bitbucket.org/bpbrown/polytrope/src/3d7a3022f4c4c23db02bb796bf5fa11c38cb276f/equations.py?at=default#cl-352\n\n(private repo, just sent invite to Keaton).\n\n\nYes, please change the title of the issue.\n", "markup": "markdown", "html": "<p>Keaton,\n     Just tested your fix, and it works.  Interestingly, \"enstrophy\" is not the only repeated analysis substitution, but it is the only substitution that appears 3 times (the rest appear twice).  For example, this KE sub works just fine with no \"store_last=True\" flag:</p>\n<div class=\"codehilite language-python\"><pre><span></span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">problem</span><span class=\"o\">.</span><span class=\"n\">substitutions</span><span class=\"p\">[</span><span class=\"s1\">&#39;KE&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;rho_full*(u**2+w**2)/2&#39;</span>\n<span class=\"o\">&lt;...&gt;</span>\n<span class=\"n\">analysis_profile</span><span class=\"o\">.</span><span class=\"n\">add_task</span><span class=\"p\">(</span><span class=\"s2\">&quot;plane_avg(KE)&quot;</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;KE&quot;</span><span class=\"p\">)</span>\n<span class=\"o\">&lt;...&gt;</span>\n<span class=\"n\">analysis_scalar</span><span class=\"o\">.</span><span class=\"n\">add_task</span><span class=\"p\">(</span><span class=\"s2\">&quot;vol_avg(KE)&quot;</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;KE&quot;</span><span class=\"p\">)</span>\n</pre></div>\n\n\n<p>whereas the enstrophy sub requires that fix:</p>\n<div class=\"codehilite language-python\"><pre><span></span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">problem</span><span class=\"o\">.</span><span class=\"n\">substitutions</span><span class=\"p\">[</span><span class=\"s1\">&#39;enstrophy&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;(dx(w) - u_z)**2&#39;</span>\n<span class=\"o\">&lt;...&gt;</span>\n<span class=\"n\">analysis_slice</span><span class=\"o\">.</span><span class=\"n\">add_task</span><span class=\"p\">(</span><span class=\"s2\">&quot;enstrophy&quot;</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;enstrophy&quot;</span><span class=\"p\">)</span>\n<span class=\"o\">&lt;...&gt;</span>\n<span class=\"n\">analysis_profile</span><span class=\"o\">.</span><span class=\"n\">add_task</span><span class=\"p\">(</span><span class=\"s2\">&quot;plane_avg(enstrophy)&quot;</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;enstrophy&quot;</span><span class=\"p\">)</span>\n<span class=\"o\">&lt;...&gt;</span>\n<span class=\"n\">analysis_scalar</span><span class=\"o\">.</span><span class=\"n\">add_task</span><span class=\"p\">(</span><span class=\"s2\">&quot;vol_avg(enstrophy)&quot;</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;enstrophy&quot;</span><span class=\"p\">)</span>\n<span class=\"o\">&lt;...&gt;</span>\n<span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">problem</span><span class=\"o\">.</span><span class=\"n\">namespace</span><span class=\"p\">[</span><span class=\"s1\">&#39;enstrophy&#39;</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">store_last</span> <span class=\"o\">=</span> <span class=\"bp\">True</span>\n</pre></div>\n\n\n<p>If you want to dig into this more, these subs are being set in equations.py in <a href=\"https://bitbucket.org/bpbrown/polytrope\" rel=\"nofollow\" class=\"ap-connect-link\">bpbrown/polytrope</a> here:</p>\n<p><a href=\"https://bitbucket.org/bpbrown/polytrope/src/3d7a3022f4c4c23db02bb796bf5fa11c38cb276f/equations.py?at=default#cl-352\" rel=\"nofollow\" class=\"ap-connect-link\">https://bitbucket.org/bpbrown/polytrope/src/3d7a3022f4c4c23db02bb796bf5fa11c38cb276f/equations.py?at=default#cl-352</a></p>\n<p>(private repo, just sent invite to Keaton).</p>\n<p>Yes, please change the title of the issue.</p>", "type": "rendered"}, "created_on": "2015-06-29T18:24:08.465307+00:00", "user": {"display_name": "Benjamin Brown", "uuid": "{7ccecdb3-3639-4001-8249-060e80320bda}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B7ccecdb3-3639-4001-8249-060e80320bda%7D"}, "html": {"href": "https://bitbucket.org/%7B7ccecdb3-3639-4001-8249-060e80320bda%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:0696c4b9-e94c-41ac-82be-62ad4f0ec571/8bc6f4da-871a-48b1-88ea-998663d18142/128"}}, "nickname": "Benjamin Brown", "type": "user", "account_id": "557058:0696c4b9-e94c-41ac-82be-62ad4f0ec571"}, "updated_on": null, "type": "issue_comment", "id": 19372688}, {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus/issues/29/comments/19372799.json"}, "html": {"href": "#!/dedalus-project/dedalus/issues/29#comment-19372799"}}, "issue": {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus/issues/29.json"}}, "type": "issue", "id": 29, "repository": {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus.json"}, "html": {"href": "#!/dedalus-project/dedalus"}, "avatar": {"href": "data/bytebucket.org/ravatar/{1dc39ab6-2798-450d-af2f-e976f94b5794}ts=2009435"}}, "type": "repository", "name": "dedalus", "full_name": "dedalus-project/dedalus", "uuid": "{1dc39ab6-2798-450d-af2f-e976f94b5794}"}, "title": "Proper evaluation of duplicated subtrees"}, "content": {"raw": "Yep it's not just due to the presence of duplicated subtrees, but details of which layouts different parts of the tree were in when the duplicates complete their evaluation, etc.  I think that even in the cases where duplicate trees don't result in a crash, adding the cache flag might generally speed up their evaluation, so it might be worth trying.", "markup": "markdown", "html": "<p>Yep it's not just due to the presence of duplicated subtrees, but details of which layouts different parts of the tree were in when the duplicates complete their evaluation, etc.  I think that even in the cases where duplicate trees don't result in a crash, adding the cache flag might generally speed up their evaluation, so it might be worth trying.</p>", "type": "rendered"}, "created_on": "2015-06-29T18:30:52.544125+00:00", "user": {"display_name": "Keaton Burns", "uuid": "{3d3e64f1-bf12-45df-b655-4543d8fb34c4}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B3d3e64f1-bf12-45df-b655-4543d8fb34c4%7D"}, "html": {"href": "https://bitbucket.org/%7B3d3e64f1-bf12-45df-b655-4543d8fb34c4%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:e31a7835-5317-4dfa-8551-f32a06f40279/40f33f99-2b75-4a17-a8c2-07c8d74c7480/128"}}, "nickname": "kburns", "type": "user", "account_id": "557058:e31a7835-5317-4dfa-8551-f32a06f40279"}, "updated_on": null, "type": "issue_comment", "id": 19372799}, {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus/issues/29/comments/19372807.json"}, "html": {"href": "#!/dedalus-project/dedalus/issues/29#comment-19372807"}}, "issue": {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus/issues/29.json"}}, "type": "issue", "id": 29, "repository": {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus.json"}, "html": {"href": "#!/dedalus-project/dedalus"}, "avatar": {"href": "data/bytebucket.org/ravatar/{1dc39ab6-2798-450d-af2f-e976f94b5794}ts=2009435"}}, "type": "repository", "name": "dedalus", "full_name": "dedalus-project/dedalus", "uuid": "{1dc39ab6-2798-450d-af2f-e976f94b5794}"}, "title": "Proper evaluation of duplicated subtrees"}, "content": {"raw": null, "markup": "markdown", "html": "", "type": "rendered"}, "created_on": "2015-06-29T18:31:14.884314+00:00", "user": {"display_name": "Keaton Burns", "uuid": "{3d3e64f1-bf12-45df-b655-4543d8fb34c4}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B3d3e64f1-bf12-45df-b655-4543d8fb34c4%7D"}, "html": {"href": "https://bitbucket.org/%7B3d3e64f1-bf12-45df-b655-4543d8fb34c4%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:e31a7835-5317-4dfa-8551-f32a06f40279/40f33f99-2b75-4a17-a8c2-07c8d74c7480/128"}}, "nickname": "kburns", "type": "user", "account_id": "557058:e31a7835-5317-4dfa-8551-f32a06f40279"}, "updated_on": null, "type": "issue_comment", "id": 19372807}, {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus/issues/29/comments/19372830.json"}, "html": {"href": "#!/dedalus-project/dedalus/issues/29#comment-19372830"}}, "issue": {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus/issues/29.json"}}, "type": "issue", "id": 29, "repository": {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus.json"}, "html": {"href": "#!/dedalus-project/dedalus"}, "avatar": {"href": "data/bytebucket.org/ravatar/{1dc39ab6-2798-450d-af2f-e976f94b5794}ts=2009435"}}, "type": "repository", "name": "dedalus", "full_name": "dedalus-project/dedalus", "uuid": "{1dc39ab6-2798-450d-af2f-e976f94b5794}"}, "title": "Proper evaluation of duplicated subtrees"}, "content": {"raw": null, "markup": "markdown", "html": "", "type": "rendered"}, "created_on": "2015-06-29T18:32:29.950431+00:00", "user": {"display_name": "Keaton Burns", "uuid": "{3d3e64f1-bf12-45df-b655-4543d8fb34c4}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B3d3e64f1-bf12-45df-b655-4543d8fb34c4%7D"}, "html": {"href": "https://bitbucket.org/%7B3d3e64f1-bf12-45df-b655-4543d8fb34c4%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:e31a7835-5317-4dfa-8551-f32a06f40279/40f33f99-2b75-4a17-a8c2-07c8d74c7480/128"}}, "nickname": "kburns", "type": "user", "account_id": "557058:e31a7835-5317-4dfa-8551-f32a06f40279"}, "updated_on": null, "type": "issue_comment", "id": 19372830}, {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus/issues/29/comments/28992460.json"}, "html": {"href": "#!/dedalus-project/dedalus/issues/29#comment-28992460"}}, "issue": {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus/issues/29.json"}}, "type": "issue", "id": 29, "repository": {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus.json"}, "html": {"href": "#!/dedalus-project/dedalus"}, "avatar": {"href": "data/bytebucket.org/ravatar/{1dc39ab6-2798-450d-af2f-e976f94b5794}ts=2009435"}}, "type": "repository", "name": "dedalus", "full_name": "dedalus-project/dedalus", "uuid": "{1dc39ab6-2798-450d-af2f-e976f94b5794}"}, "title": "Proper evaluation of duplicated subtrees"}, "content": {"raw": "I've pushed a quick patch in commit a1fb41a that just enables output caching on all expression substitutions.  This should be a decent balance that fixes this problem without enabling caching on every expression, which could lead to memory problems.\n\nBen, if you get a chance to test it on some other scripts that were showing this problem, that would be great!", "markup": "markdown", "html": "<p>I've pushed a quick patch in commit <a href=\"#!/dedalus-project/dedalus/commits/a1fb41a\" rel=\"nofollow\" class=\"ap-connect-link\">a1fb41a</a> that just enables output caching on all expression substitutions.  This should be a decent balance that fixes this problem without enabling caching on every expression, which could lead to memory problems.</p>\n<p>Ben, if you get a chance to test it on some other scripts that were showing this problem, that would be great!</p>", "type": "rendered"}, "created_on": "2016-07-05T13:43:41.032145+00:00", "user": {"display_name": "Keaton Burns", "uuid": "{3d3e64f1-bf12-45df-b655-4543d8fb34c4}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B3d3e64f1-bf12-45df-b655-4543d8fb34c4%7D"}, "html": {"href": "https://bitbucket.org/%7B3d3e64f1-bf12-45df-b655-4543d8fb34c4%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:e31a7835-5317-4dfa-8551-f32a06f40279/40f33f99-2b75-4a17-a8c2-07c8d74c7480/128"}}, "nickname": "kburns", "type": "user", "account_id": "557058:e31a7835-5317-4dfa-8551-f32a06f40279"}, "updated_on": null, "type": "issue_comment", "id": 28992460}, {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus/issues/29/comments/48650936.json"}, "html": {"href": "#!/dedalus-project/dedalus/issues/29#comment-48650936"}}, "issue": {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus/issues/29.json"}}, "type": "issue", "id": 29, "repository": {"links": {"self": {"href": "data/repositories/dedalus-project/dedalus.json"}, "html": {"href": "#!/dedalus-project/dedalus"}, "avatar": {"href": "data/bytebucket.org/ravatar/{1dc39ab6-2798-450d-af2f-e976f94b5794}ts=2009435"}}, "type": "repository", "name": "dedalus", "full_name": "dedalus-project/dedalus", "uuid": "{1dc39ab6-2798-450d-af2f-e976f94b5794}"}, "title": "Proper evaluation of duplicated subtrees"}, "content": {"raw": null, "markup": "markdown", "html": "", "type": "rendered"}, "created_on": "2018-10-30T21:07:57.040309+00:00", "user": {"display_name": "Keaton Burns", "uuid": "{3d3e64f1-bf12-45df-b655-4543d8fb34c4}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B3d3e64f1-bf12-45df-b655-4543d8fb34c4%7D"}, "html": {"href": "https://bitbucket.org/%7B3d3e64f1-bf12-45df-b655-4543d8fb34c4%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:e31a7835-5317-4dfa-8551-f32a06f40279/40f33f99-2b75-4a17-a8c2-07c8d74c7480/128"}}, "nickname": "kburns", "type": "user", "account_id": "557058:e31a7835-5317-4dfa-8551-f32a06f40279"}, "updated_on": null, "type": "issue_comment", "id": 48650936}], "page": 1, "size": 7}